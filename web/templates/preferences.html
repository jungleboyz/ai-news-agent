{% extends "base.html" %}

{% block title %}Preferences - AI News Agent{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-white mb-8">Preferences</h1>

    <!-- User Info -->
    <div class="bg-slate-800 rounded-xl p-6 mb-8 border border-slate-700">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-medium text-white">Your Profile</h2>
                <p class="text-sm text-slate-400 mt-1">User ID: {{ user_id }}</p>
            </div>
            <button
                onclick="resetPreferences()"
                class="px-4 py-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition-colors text-sm">
                Reset All Preferences
            </button>
        </div>
    </div>

    <!-- Active Preset -->
    <div class="bg-slate-800 rounded-xl p-6 mb-8 border border-slate-700">
        <h2 class="text-xl font-bold text-white mb-4">Active Preset</h2>
        {% if active_preset %}
        <div class="flex items-center gap-4">
            <span class="bg-emerald-600 text-white px-3 py-1 rounded-full text-sm">
                {{ active_preset["name"] }}
            </span>
            <span class="text-slate-400 text-sm">
                Personalized recommendations enabled
            </span>
        </div>
        {% else %}
        <p class="text-slate-400">No active preset. Select one below to enable personalized recommendations.</p>
        {% endif %}
    </div>

    <!-- Presets Grid -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white">Preference Presets</h2>
            <button
                onclick="showCreatePresetModal()"
                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm">
                + Create Preset
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for preset in presets %}
            <div class="bg-slate-800 rounded-lg p-5 border border-slate-700 {% if preset['is_active'] %}ring-2 ring-emerald-500{% endif %}">
                <div class="flex items-start justify-between mb-3">
                    <h3 class="text-lg font-medium text-white">{{ preset['name'] }}</h3>
                    {% if preset['is_active'] %}
                    <span class="bg-emerald-600 text-white text-xs px-2 py-1 rounded">Active</span>
                    {% endif %}
                </div>

                <div class="flex flex-wrap gap-2 mb-4">
                    {% for interest in preset['interests'] %}
                    <span class="bg-slate-700 text-slate-300 text-xs px-2 py-1 rounded">
                        {{ interest[:30] }}{% if interest|length > 30 %}...{% endif %}
                    </span>
                    {% endfor %}
                </div>

                <div class="flex gap-2">
                    {% if not preset['is_active'] %}
                    <button
                        onclick="activatePreset({{ preset['id'] }})"
                        class="flex-1 px-3 py-2 bg-emerald-600/20 text-emerald-400 rounded-lg hover:bg-emerald-600/30 transition-colors text-sm">
                        Activate
                    </button>
                    {% endif %}
                    <button
                        onclick="deletePreset({{ preset['id'] }}, '{{ preset['name'] }}')"
                        class="px-3 py-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition-colors text-sm">
                        Delete
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Interactions -->
    <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
        <h2 class="text-xl font-bold text-white mb-4">Recent Activity</h2>

        {% if interactions %}
        <div class="space-y-3 max-h-96 overflow-y-auto">
            {% for interaction in interactions %}
            <div class="flex items-center gap-4 p-3 bg-slate-900 rounded-lg">
                <span class="
                    {% if interaction.action == 'click' %}bg-blue-600
                    {% elif interaction.action == 'save' %}bg-emerald-600
                    {% elif interaction.action == 'skip' %}bg-yellow-600
                    {% elif interaction.action == 'hide' %}bg-red-600
                    {% else %}bg-slate-600{% endif %}
                    text-white text-xs px-2 py-1 rounded uppercase min-w-[60px] text-center">
                    {{ interaction.action }}
                </span>
                <div class="flex-1 min-w-0">
                    <a href="{{ interaction.item.link }}" target="_blank"
                       class="text-sm text-white hover:text-emerald-400 truncate block">
                        {{ interaction.item.title[:80] }}{% if interaction.item.title|length > 80 %}...{% endif %}
                    </a>
                    <span class="text-xs text-slate-500">
                        {{ interaction.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-slate-400">No interactions yet. Browse news items to start building your preferences.</p>
        {% endif %}
    </div>
</div>

<!-- Create Preset Modal -->
<div id="createPresetModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4 border border-slate-700">
        <h2 class="text-xl font-bold text-white mb-4">Create New Preset</h2>

        <form onsubmit="createPreset(event)">
            <div class="mb-4">
                <label class="block text-sm text-slate-300 mb-2">Preset Name</label>
                <input
                    type="text"
                    id="presetName"
                    required
                    class="w-full px-4 py-2 bg-slate-900 text-white rounded-lg border border-slate-600 focus:border-emerald-500 focus:outline-none"
                    placeholder="e.g., AI Research">
            </div>

            <div class="mb-4">
                <label class="block text-sm text-slate-300 mb-2">Interests (one per line)</label>
                <textarea
                    id="presetInterests"
                    required
                    rows="5"
                    class="w-full px-4 py-2 bg-slate-900 text-white rounded-lg border border-slate-600 focus:border-emerald-500 focus:outline-none resize-none"
                    placeholder="machine learning research&#10;neural networks&#10;AI safety"></textarea>
            </div>

            <div class="mb-6">
                <label class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer">
                    <input type="checkbox" id="activateOnCreate" class="rounded">
                    Activate this preset immediately
                </label>
            </div>

            <div class="flex gap-3">
                <button
                    type="button"
                    onclick="hideCreatePresetModal()"
                    class="flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors">
                    Cancel
                </button>
                <button
                    type="submit"
                    class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors">
                    Create
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showCreatePresetModal() {
    document.getElementById('createPresetModal').classList.remove('hidden');
    document.getElementById('createPresetModal').classList.add('flex');
}

function hideCreatePresetModal() {
    document.getElementById('createPresetModal').classList.add('hidden');
    document.getElementById('createPresetModal').classList.remove('flex');
    document.getElementById('presetName').value = '';
    document.getElementById('presetInterests').value = '';
    document.getElementById('activateOnCreate').checked = false;
}

async function createPreset(event) {
    event.preventDefault();

    const name = document.getElementById('presetName').value;
    const interestsText = document.getElementById('presetInterests').value;
    const activate = document.getElementById('activateOnCreate').checked;

    const interests = interestsText.split('\n').map(s => s.trim()).filter(s => s);

    if (interests.length === 0) {
        alert('Please enter at least one interest');
        return;
    }

    try {
        const response = await fetch('/api/preferences/presets', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, interests, activate })
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert('Error creating preset: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error creating preset: ' + error.message);
    }
}

async function activatePreset(presetId) {
    try {
        const response = await fetch(`/api/preferences/presets/${presetId}/activate`, {
            method: 'PUT'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert('Error activating preset: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error activating preset: ' + error.message);
    }
}

async function deletePreset(presetId, name) {
    if (!confirm(`Delete preset "${name}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/preferences/presets/${presetId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert('Error deleting preset: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting preset: ' + error.message);
    }
}

async function resetPreferences() {
    if (!confirm('This will delete all your interactions and presets. Are you sure?')) {
        return;
    }

    try {
        const response = await fetch('/api/preferences/reset', {
            method: 'POST'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert('Error resetting preferences: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error resetting preferences: ' + error.message);
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideCreatePresetModal();
    }
});

// Close modal on background click
document.getElementById('createPresetModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideCreatePresetModal();
    }
});
</script>
{% endblock %}
