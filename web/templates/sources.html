{% extends "base.html" %}

{% block title %}Sources - AI News Agent{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold text-white font-cyber neon-text">Source Management</h1>
        <div class="flex gap-3">
            <button onclick="importFromFiles()" id="importBtn"
                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                Import from Files
            </button>
            <button onclick="runDiscovery()" id="discoverBtn"
                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm">
                Discover New
            </button>
            <button onclick="checkDuplicates()" id="dupeBtn"
                class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors text-sm">
                Check Duplicates
            </button>
            <button onclick="recalculateScores()" id="recalcBtn"
                class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors text-sm">
                Recalculate Scores
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-cyber-card rounded-lg p-4 border border-gray-800/50">
            <div class="text-2xl font-bold text-neon-cyan font-cyber">{{ total_feeds }}</div>
            <div class="text-sm text-slate-400">Total Feeds</div>
        </div>
        <div class="bg-cyber-card rounded-lg p-4 border border-gray-800/50">
            <div class="text-2xl font-bold text-neon-green font-cyber">{{ active_feeds }}</div>
            <div class="text-sm text-slate-400">Active</div>
        </div>
        <div class="bg-cyber-card rounded-lg p-4 border border-gray-800/50">
            <div class="text-2xl font-bold text-red-400 font-cyber">{{ error_feeds }}</div>
            <div class="text-sm text-slate-400">Errors</div>
        </div>
        <div class="bg-cyber-card rounded-lg p-4 border border-gray-800/50">
            <div class="text-2xl font-bold text-neon-magenta font-cyber">{{ recent_discoveries|length }}</div>
            <div class="text-sm text-slate-400">Pending Review</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-1 mb-6 border-b border-gray-800/50">
        <button onclick="showTab('news')" id="tab-news" class="tab-btn px-5 py-2.5 text-sm font-medium text-white border-b-2 border-neon-cyan transition-colors">
            News <span class="ml-1 text-xs text-slate-400">({{ news_feeds|length }})</span>
        </button>
        <button onclick="showTab('podcasts')" id="tab-podcasts" class="tab-btn px-5 py-2.5 text-sm font-medium text-slate-400 border-b-2 border-transparent hover:text-white transition-colors">
            Podcasts <span class="ml-1 text-xs text-slate-500">({{ podcast_feeds|length }})</span>
        </button>
        <button onclick="showTab('videos')" id="tab-videos" class="tab-btn px-5 py-2.5 text-sm font-medium text-slate-400 border-b-2 border-transparent hover:text-white transition-colors">
            Videos <span class="ml-1 text-xs text-slate-500">({{ video_feeds|length }})</span>
        </button>
        <button onclick="showTab('web')" id="tab-web" class="tab-btn px-5 py-2.5 text-sm font-medium text-slate-400 border-b-2 border-transparent hover:text-white transition-colors">
            Web <span class="ml-1 text-xs text-slate-500">({{ web_feeds|length }})</span>
        </button>
        <button onclick="showTab('discovery')" id="tab-discovery" class="tab-btn px-5 py-2.5 text-sm font-medium text-slate-400 border-b-2 border-transparent hover:text-white transition-colors">
            Discovery <span class="ml-1 text-xs text-slate-500">({{ recent_discoveries|length }})</span>
        </button>
    </div>

    <!-- News Tab -->
    <div id="content-news" class="tab-content">
        {% set type_name = "news" %}
        {% set feeds = news_feeds %}
        {% include "partials/feed_tab.html" %}
    </div>

    <!-- Podcasts Tab -->
    <div id="content-podcasts" class="tab-content hidden">
        {% set type_name = "podcast" %}
        {% set feeds = podcast_feeds %}
        {% include "partials/feed_tab.html" %}
    </div>

    <!-- Videos Tab -->
    <div id="content-videos" class="tab-content hidden">
        {% set type_name = "video" %}
        {% set feeds = video_feeds %}
        {% include "partials/feed_tab.html" %}
    </div>

    <!-- Web Tab -->
    <div id="content-web" class="tab-content hidden">
        {% set type_name = "web" %}
        {% set feeds = web_feeds %}
        {% include "partials/feed_tab.html" %}
    </div>

    <!-- Discovery Tab -->
    <div id="content-discovery" class="tab-content hidden">
        <div class="space-y-4">
            {% for discovery in recent_discoveries %}
            <div class="bg-cyber-card rounded-lg p-4 border border-gray-800/50" id="discovery-{{ discovery.id }}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="{% if discovery.discovered_from == 'hackernews' %}bg-orange-600{% else %}bg-blue-600{% endif %} text-white text-xs px-2 py-1 rounded uppercase font-medium">
                                {{ discovery.discovered_from }}
                            </span>
                            <span class="text-slate-400 text-sm">{{ discovery.domain }}</span>
                            <span class="text-slate-500 text-sm font-mono">Score: {{ discovery.external_score }}</span>
                        </div>
                        <a href="{{ discovery.url }}" target="_blank" class="text-white hover:text-neon-cyan transition-colors">
                            {{ discovery.title or discovery.url }}
                        </a>
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button onclick="approveDiscovery({{ discovery.id }})"
                            class="px-3 py-1.5 bg-emerald-600/20 text-emerald-400 rounded hover:bg-emerald-600/30 text-sm transition-colors">
                            Approve
                        </button>
                        <button onclick="rejectDiscovery({{ discovery.id }})"
                            class="px-3 py-1.5 bg-red-600/20 text-red-400 rounded hover:bg-red-600/30 text-sm transition-colors">
                            Reject
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if not recent_discoveries %}
            <div class="bg-cyber-card rounded-lg p-8 border border-gray-800/50 text-center text-slate-400">
                No pending discoveries. Click "Discover New" to find sources from HackerNews and Reddit.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('text-white', 'border-neon-cyan');
        el.classList.add('text-slate-400', 'border-transparent');
    });
    document.getElementById('content-' + tabName).classList.remove('hidden');
    const tab = document.getElementById('tab-' + tabName);
    tab.classList.add('text-white', 'border-neon-cyan');
    tab.classList.remove('text-slate-400', 'border-transparent');
}

async function addFeed(sourceType) {
    const urlInput = document.getElementById('add-url-' + sourceType);
    const nameInput = document.getElementById('add-name-' + sourceType);
    const url = urlInput.value.trim();
    if (!url) return;

    try {
        const resp = await fetch('/api/feeds', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                feed_url: url,
                source_type: sourceType,
                name: nameInput.value.trim() || null,
            }),
        });
        const data = await resp.json();
        if (resp.ok && data.success) {
            if (data.warning) {
                showToast(`Added "${data.feed.name}" - Warning: ${data.warning}`, 'warning');
            } else {
                showToast(`Added "${data.feed.name}"`, 'success');
            }
            window.location.reload();
        } else {
            showToast(data.detail || 'Failed to add feed', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function toggleFeed(feedId) {
    const row = document.getElementById('feed-' + feedId);
    const badge = row.querySelector('.status-badge');
    const currentStatus = badge.dataset.status;
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';

    try {
        const resp = await fetch(`/api/feeds/${feedId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: newStatus}),
        });
        const data = await resp.json();
        if (resp.ok && data.success) {
            badge.dataset.status = data.status;
            if (data.status === 'active') {
                badge.className = 'status-badge px-2 py-0.5 rounded text-xs font-medium bg-emerald-600/20 text-emerald-400';
                badge.textContent = 'Active';
            } else {
                badge.className = 'status-badge px-2 py-0.5 rounded text-xs font-medium bg-slate-600/30 text-slate-400';
                badge.textContent = 'Inactive';
            }
            showToast(`Feed ${data.status}`, 'success');
        }
    } catch (e) {
        showToast('Toggle failed: ' + e.message, 'error');
    }
}

async function testFeed(feedId) {
    const btn = document.querySelector(`#feed-${feedId} .test-btn`);
    btn.disabled = true;
    btn.textContent = 'Testing...';

    try {
        const resp = await fetch(`/api/feeds/${feedId}/test`, {method: 'POST'});
        const data = await resp.json();
        if (data.success) {
            showToast(`Feed OK: ${data.item_count} items found`, 'success');
        } else {
            showToast(`Feed error: ${data.error}`, 'error');
        }
        // Reload to show updated status
        setTimeout(() => window.location.reload(), 1000);
    } catch (e) {
        showToast('Test failed: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Test';
    }
}

async function deleteFeed(feedId, feedName) {
    if (!confirm(`Delete "${feedName}"? This cannot be undone.`)) return;

    try {
        const resp = await fetch(`/api/feeds/${feedId}`, {method: 'DELETE'});
        const data = await resp.json();
        if (resp.ok && data.success) {
            document.getElementById('feed-' + feedId).remove();
            showToast(`Deleted "${feedName}"`, 'success');
        }
    } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
    }
}

async function importFromFiles() {
    const btn = document.getElementById('importBtn');
    btn.disabled = true;
    btn.textContent = 'Importing...';

    try {
        const resp = await fetch('/api/feeds/import', {method: 'POST'});
        const data = await resp.json();
        if (data.success) {
            let msg = `Imported ${data.imported} feeds from .txt files`;
            if (data.warning) msg += ` (${data.warning})`;
            showToast(msg, data.warning ? 'warning' : 'success');
            if (data.imported > 0) window.location.reload();
        }
    } catch (e) {
        showToast('Import failed: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Import from Files';
    }
}

async function runDiscovery() {
    const btn = document.getElementById('discoverBtn');
    btn.disabled = true;
    btn.textContent = 'Discovering...';

    try {
        const resp = await fetch('/api/sources/discover', {method: 'POST'});
        const data = await resp.json();
        if (data.success) {
            showToast(`Discovery complete! Found ${data.results.unique_domains} domains`, 'success');
            window.location.reload();
        }
    } catch (e) {
        showToast('Discovery failed: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Discover New';
    }
}

async function recalculateScores() {
    const btn = document.getElementById('recalcBtn');
    btn.disabled = true;
    btn.textContent = 'Recalculating...';

    try {
        const resp = await fetch('/api/sources/recalculate', {method: 'POST'});
        const data = await resp.json();
        showToast(`Recalculated ${data.updated_count} source scores`, 'success');
    } catch (e) {
        showToast('Recalculation failed: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Recalculate Scores';
    }
}

async function approveDiscovery(id) {
    try {
        const resp = await fetch(`/api/sources/discoveries/${id}/approve`, {method: 'PUT'});
        if (resp.ok) {
            document.getElementById('discovery-' + id).remove();
            showToast('Source approved', 'success');
        }
    } catch (e) {
        showToast('Approval failed: ' + e.message, 'error');
    }
}

async function rejectDiscovery(id) {
    try {
        const resp = await fetch(`/api/sources/discoveries/${id}/reject`, {method: 'PUT'});
        if (resp.ok) {
            document.getElementById('discovery-' + id).remove();
            showToast('Source rejected', 'success');
        }
    } catch (e) {
        showToast('Rejection failed: ' + e.message, 'error');
    }
}

async function checkDuplicates() {
    const btn = document.getElementById('dupeBtn');
    btn.disabled = true;
    btn.textContent = 'Checking...';

    try {
        const resp = await fetch('/api/feeds/duplicates');
        const data = await resp.json();
        if (data.duplicate_groups === 0) {
            showToast('No duplicate feeds found', 'success');
        } else {
            // Show duplicate details in a modal-like overlay
            let html = `<div id="dupeOverlay" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                <div class="bg-gray-900 rounded-xl border border-gray-700 max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Duplicate Feeds (${data.duplicate_groups} groups)</h2>
                        <button onclick="document.getElementById('dupeOverlay').remove()" class="text-slate-400 hover:text-white text-2xl">&times;</button>
                    </div>`;
            for (const group of data.duplicates) {
                const badge = group.cross_type
                    ? '<span class="text-xs bg-blue-600/30 text-blue-400 px-2 py-0.5 rounded ml-2">cross-type</span>'
                    : '<span class="text-xs bg-amber-600/30 text-amber-400 px-2 py-0.5 rounded ml-2">same-type</span>';
                html += `<div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-700">
                    <div class="font-medium text-white mb-2">${group.domain} (${group.count} feeds)${badge}</div>`;
                for (const feed of group.feeds) {
                    html += `<div class="text-sm text-slate-400 ml-2 mb-1">
                        <span class="text-xs bg-slate-700 px-1.5 py-0.5 rounded mr-2">${feed.source_type}</span>
                        <span class="text-slate-300">${feed.name}</span>
                        <span class="text-slate-500 text-xs ml-1">${feed.status}</span>
                    </div>`;
                }
                html += '</div>';
            }
            html += `<div class="flex justify-end gap-3 mt-4">
                        <button onclick="document.getElementById('dupeOverlay').remove()" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 text-sm">Close</button>
                        <button onclick="autoDeduplicate()" id="autoDedupeBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">Auto-Remove Same-Type Duplicates</button>
                    </div>
                </div></div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }
    } catch (e) {
        showToast('Check failed: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Check Duplicates';
    }
}

async function autoDeduplicate() {
    const btn = document.getElementById('autoDedupeBtn');
    if (!confirm('This will remove same-type duplicate feeds, keeping the best one per domain. Continue?')) return;
    btn.disabled = true;
    btn.textContent = 'Removing...';

    try {
        const resp = await fetch('/api/feeds/deduplicate', {method: 'POST'});
        const data = await resp.json();
        showToast(data.message, 'success');
        document.getElementById('dupeOverlay')?.remove();
        if (data.removed > 0) window.location.reload();
    } catch (e) {
        showToast('Deduplication failed: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Auto-Remove Same-Type Duplicates';
    }
}

// Fallback showToast if base template doesn't provide one
if (typeof showToast === 'undefined') {
    function showToast(msg, type) {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-sm z-50 transition-opacity duration-300 ${
            type === 'error' ? 'bg-red-600 text-white' : type === 'warning' ? 'bg-amber-600 text-white' : 'bg-emerald-600 text-white'
        }`;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    }
}
</script>
{% endblock %}
