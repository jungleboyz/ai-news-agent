{% extends "base.html" %}

{% block title %}Topics - AI News Agent{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-white">Topics</h1>

        <!-- Date filter -->
        <form method="get" class="flex items-center gap-4">
            <select name="digest_date"
                    class="bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700 focus:border-blue-500 focus:outline-none"
                    onchange="this.form.submit()">
                <option value="">All dates</option>
                {% for d in available_dates %}
                <option value="{{ d }}" {% if selected_date == d|string %}selected{% endif %}>
                    {{ d }}
                </option>
                {% endfor %}
            </select>
        </form>
    </div>

    {% if clusters %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for cluster_data in clusters %}
        {% set cluster = cluster_data.cluster %}
        {% set items = cluster_data.items %}
        <div class="bg-gray-800 rounded-xl p-6 hover:bg-gray-750 transition-colors border border-gray-700">
            <div class="flex items-start justify-between mb-4">
                <h2 class="text-xl font-semibold text-white">{{ cluster.label }}</h2>
                <span class="bg-blue-600 text-white text-sm px-3 py-1 rounded-full">
                    {{ cluster.item_count }} items
                </span>
            </div>

            {% if cluster.summary %}
            <p class="text-gray-400 text-sm mb-4 line-clamp-3">{{ cluster.summary }}</p>
            {% endif %}

            <div class="space-y-2 mb-4">
                {% for item in items %}
                <a href="{{ item.link }}" target="_blank"
                   class="block text-sm text-gray-300 hover:text-blue-400 truncate">
                    <span class="text-gray-500">{{ item.type|upper }}:</span> {{ item.title }}
                </a>
                {% endfor %}
                {% if cluster.item_count > 3 %}
                <span class="text-gray-500 text-sm">+ {{ cluster.item_count - 3 }} more</span>
                {% endif %}
            </div>

            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500">
                    {% if cluster_data.digest_date %}
                    {{ cluster_data.digest_date }}
                    {% endif %}
                </span>
                <a href="/topics/{{ cluster.cluster_id }}"
                   class="text-blue-400 hover:text-blue-300">
                    View all &rarr;
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16">
        <div class="text-gray-400 text-lg mb-4">No topics found</div>
        <p class="text-gray-500">Run the clustering task to generate topic groups.</p>
        <code class="block mt-4 bg-gray-800 p-4 rounded-lg text-sm text-gray-300">
            python -c "from tasks.clustering_tasks import cluster_latest_digest; cluster_latest_digest()"
        </code>
    </div>
    {% endif %}
</div>
{% endblock %}
