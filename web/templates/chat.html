{% extends "base.html" %}

{% block title %}Chat - AI News Agent{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-white">AI News Chat</h1>
        <button onclick="clearChat()" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors text-sm">
            Clear Chat
        </button>
    </div>

    <!-- Chat container -->
    <div class="bg-slate-800 rounded-xl border border-slate-700 flex flex-col" style="height: 600px;">
        <!-- Messages area -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Welcome message -->
            <div class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-white text-sm shrink-0">
                    AI
                </div>
                <div class="flex-1">
                    <div class="bg-slate-700 rounded-lg p-4 text-slate-200">
                        <p>Hello! I'm your AI news assistant. I can help you with:</p>
                        <ul class="mt-2 ml-4 list-disc text-slate-300">
                            <li>Summarizing recent AI news</li>
                            <li>Answering questions about AI developments</li>
                            <li>Finding specific topics or stories</li>
                            <li>Explaining connections between news items</li>
                        </ul>
                        <p class="mt-3">Try one of the suggested questions below, or ask your own!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suggested questions -->
        <div id="suggestionsContainer" class="px-4 pb-2">
            <div class="flex flex-wrap gap-2">
                {% for suggestion in suggestions %}
                <button onclick="sendMessage('{{ suggestion }}')"
                    class="px-3 py-1.5 bg-slate-700 text-slate-300 rounded-full text-sm hover:bg-slate-600 hover:text-white transition-colors">
                    {{ suggestion }}
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Input area -->
        <div class="p-4 border-t border-slate-700">
            <form onsubmit="handleSubmit(event)" class="flex gap-3">
                <input type="text" id="messageInput"
                    placeholder="Ask about AI news..."
                    class="flex-1 px-4 py-3 bg-slate-900 text-white rounded-lg border border-slate-600 focus:border-emerald-500 focus:outline-none"
                    autocomplete="off">
                <button type="submit" id="sendButton"
                    class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Send
                </button>
            </form>
        </div>
    </div>

    <!-- Sources panel -->
    <div id="sourcesPanel" class="mt-4 hidden">
        <h3 class="text-sm font-medium text-slate-400 mb-2">Sources Referenced</h3>
        <div id="sourcesList" class="flex flex-wrap gap-2">
        </div>
    </div>
</div>

<script>
let conversationId = null;
let isStreaming = false;

function handleSubmit(e) {
    e.preventDefault();
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (message && !isStreaming) {
        sendMessage(message);
        input.value = '';
    }
}

async function sendMessage(message) {
    if (isStreaming) return;

    const container = document.getElementById('messagesContainer');
    const suggestionsContainer = document.getElementById('suggestionsContainer');
    const sendButton = document.getElementById('sendButton');

    // Hide suggestions after first message
    suggestionsContainer.classList.add('hidden');

    // Add user message
    container.innerHTML += `
        <div class="flex gap-3 justify-end">
            <div class="flex-1 max-w-[80%]">
                <div class="bg-emerald-600 rounded-lg p-4 text-white ml-auto">
                    ${escapeHtml(message)}
                </div>
            </div>
            <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-white text-sm shrink-0">
                You
            </div>
        </div>
    `;

    // Add assistant placeholder
    const assistantId = 'msg-' + Date.now();
    container.innerHTML += `
        <div class="flex gap-3" id="${assistantId}">
            <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-white text-sm shrink-0">
                AI
            </div>
            <div class="flex-1">
                <div class="bg-slate-700 rounded-lg p-4 text-slate-200">
                    <span class="typing-indicator">Thinking...</span>
                </div>
            </div>
        </div>
    `;

    container.scrollTop = container.scrollHeight;
    isStreaming = true;
    sendButton.disabled = true;

    try {
        // Use streaming endpoint
        const url = `/api/chat/stream?message=${encodeURIComponent(message)}${conversationId ? '&conversation_id=' + conversationId : ''}`;
        const eventSource = new EventSource(url);
        let fullResponse = '';
        let sources = [];

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'chunk') {
                fullResponse += data.content;
                updateAssistantMessage(assistantId, fullResponse);
            } else if (data.type === 'sources') {
                sources = data.sources;
                showSources(sources);
            } else if (data.type === 'done') {
                conversationId = data.conversation_id;
                eventSource.close();
                isStreaming = false;
                sendButton.disabled = false;
            } else if (data.type === 'error') {
                updateAssistantMessage(assistantId, `Error: ${data.message}`);
                eventSource.close();
                isStreaming = false;
                sendButton.disabled = false;
            }
        };

        eventSource.onerror = () => {
            eventSource.close();
            isStreaming = false;
            sendButton.disabled = false;
        };

    } catch (error) {
        updateAssistantMessage(assistantId, `Error: ${error.message}`);
        isStreaming = false;
        sendButton.disabled = false;
    }
}

function updateAssistantMessage(id, content) {
    const element = document.getElementById(id);
    if (element) {
        const contentDiv = element.querySelector('.bg-slate-700');
        contentDiv.innerHTML = formatMarkdown(content);
        document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
    }
}

function showSources(sources) {
    if (sources.length === 0) return;

    const panel = document.getElementById('sourcesPanel');
    const list = document.getElementById('sourcesList');

    panel.classList.remove('hidden');
    list.innerHTML = sources.map(s => `
        <span class="px-3 py-1 bg-slate-800 text-slate-300 rounded-full text-sm border border-slate-700">
            ${escapeHtml(s.title.substring(0, 40))}${s.title.length > 40 ? '...' : ''}
            <span class="text-slate-500">(${(s.similarity * 100).toFixed(0)}%)</span>
        </span>
    `).join('');
}

function clearChat() {
    if (conversationId) {
        fetch(`/api/chat/history/${conversationId}`, { method: 'DELETE' });
    }
    conversationId = null;

    const container = document.getElementById('messagesContainer');
    container.innerHTML = `
        <div class="flex gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-white text-sm shrink-0">
                AI
            </div>
            <div class="flex-1">
                <div class="bg-slate-700 rounded-lg p-4 text-slate-200">
                    <p>Chat cleared. How can I help you with AI news?</p>
                </div>
            </div>
        </div>
    `;

    document.getElementById('suggestionsContainer').classList.remove('hidden');
    document.getElementById('sourcesPanel').classList.add('hidden');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMarkdown(text) {
    // Basic markdown formatting
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code class="bg-slate-800 px-1 rounded">$1</code>')
        .replace(/\n/g, '<br>');
}

// Focus input on load
document.getElementById('messageInput').focus();
</script>
{% endblock %}
